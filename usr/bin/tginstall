#!/bin/sh
# Copyright (c) 2020 TorGuard forum user 19807409
# tginstall (Optional: [TorGuardConfigInterface] [WireGuardInterfaceNumber])
# Example: tginstall tg0 0
# ‚ÑπÔ∏è check submitted vars
if [ -z ${1+x} ]; then TGIF="tg0" && echo "TorGuard Interface was not submited, using default: ${TGIF}"; else TGIF="${1}" && echo "TorGuard Interface submitted: ${TGIF}"; fi
if [ -z ${2+x} ]; then WGIFNR="0" && echo "WireGuard Interface Number was not submited, using default: ${WGIFNR}"; else WGIFNR="${1}" && echo "TorGuard Interface submitted: ${WGIFNR}"; fi

# use curl or wget
if [ -f /usr/bin/curl ]; then
  echo "curl: OK - found: /usr/bin/curl"
  DBIN="/usr/bin/curl -o"
elif [ -f /usr/bin/wget ]; then
  echo "wget: OK - found: /usr/bin/wget, download init script"
  DBIN="/usr/bin/wget -O"
else
  DBIN="ERROR: script requires curl or wget with ssl support" &&  echo "$DBIN
  Install curl with:

    opkg update
    opkg install curl

  or wget-ssl with:

    opkg update
    opkg install wget-ssl"
  exit
fi

# ‚ÑπÔ∏è Initialize luci configs and install wireguard interface
if [ -f /usr/bin/tginit-uci-basic ]; then
  echo "Found: /usr/bin/tginit-uci-basic"
else
  echo "Download tginit-uci-basic script..."
  ${DBIN} /usr/bin/tginit-uci-basic https://raw.githubusercontent.com/TorGuard/openwrt-scripts/master/usr/bin/tginit-uci-basic && chmod +x /usr/bin/tginit-uci-basic
fi

if [ -f /usr/bin/tginit ]; then
  echo "Found: /usr/bin/tginit"
else
  echo "Download tginit script..."
  ${DBIN} /usr/bin/tginit https://raw.githubusercontent.com/TorGuard/openwrt-scripts/master/usr/bin/tginit && chmod +x /usr/bin/tginit;
fi

if [ -f /etc/config/torguard ]; then
  echo "Found: /etc/config/torguard"
else
  echo "Initialize torguard config file"
  tginit-uci-basic
  echo "Please set your torguard credentials which are require for API usage"
  read -p 'Set Username: ' TORGUARDUSERNAME
  #read -sp 'Set Password: ' TORGUARDPASS
  read -p 'Set Password: ' TORGUARDPASS 
  read -p "Continue (y/n)?" setcred
  case "$setcred" in 
    y|Y ) uci set torguard.@credentials_${TGIF}[0].username="$TORGUARDUSERNAME";uci set torguard.@credentials_${TGIF}[0].password="$TORGUARDPASS";uci commit torguard;;
    n|N ) echo "user abort, script finished"; exit;;
    * ) echo "invalid"; exit;;
  esac
  read -p "Per default New York server is preset, do you want to set your rsidential/streaming/...?" askserv
  case "$askserv" in 
    y|Y ) read -p "Set your server: " setserv;
          # US New York server is preset, here you can set your streaming/residential IP
          uci set torguard.@wireguard_${TGIF}[0].endpoint_host="$setserv";;
    n|N ) echo "using default script server";;
    * ) echo "invalid"; exit;;
  esac
fi

# OPKG Dependencies
DEPS="kmod-wireguard wireguard-tools"
DEPSSPEEDPERF="iperf3"

# üîê TorGuard credentials
TGUSER=$(uci get torguard.@credentials_${TGIF}[0].username)
TGPASS=$(uci get torguard.@credentials_${TGIF}[0].password)

# üÜî TorGuard interface
WGIFNR=$(uci get torguard.${TGIF}.ifstartnr)
FIREWALLZONE=$(uci get torguard.${TGIF}.zone)
WGINTERFACE=$(uci get torguard.${TGIF}.ifname)
NOHOSTROUTE=$(uci torguard.@interface_${TGIF}[0].nohostroute)
LISTENPORT=$(uci get torguard.@interface_${TGIF}[0].listen_port)
MTU=$(uci get torguard.@interface_${TGIF}[0].mtu)
FWMARK=$(uci get torguard.@interface_${TGIF}[0].fwmark)
KEEPALIVE=$(uci get torguard.@interface_${TGIF}[0].persistent_keepalive)
DELEGATE=$(uci get torguard.@interface_${TGIF}[0].delegate)
ROUTEALLOWEDIPS=$(uci get torguard.@wireguard_${TGIF}[0].route_allowed_ips)
ENDPOINT=$(uci get torguard.@wireguard_${TGIF}[0].endpoint_host):$(uci get torguard.@wireguard_${TGIF}[0].endpoint_port)
# üõ°Ô∏è Torguard server [host]:[port]
ENPOINTPORT=$(uci get torguard.@wireguard_${TGIF}[0].endpoint_port)

echo "### SETTINGS ###
TorGuard interface:             ${TGIF}

### üîê TorGuard credentials ###
TorGuard Username: ${TGUSER}
TorGuard Password: ${TGPASS}

Wireguard interface:            ${WGINTERFACE}
üÜî Wireguard interface number:   ${WGIFNR}
Assign to firewall zone:        ${FIREWALLZONE} (0 - lan, 1 - wan)
Do not create routes for hosts: ${NOHOSTROUTE} (0 - creates routes for allowed hosts , 1 - does not create routes for allowed hosts)
Listen port:                    ${LISTENPORT}
MTU:                            ${MTU}
Firewall mark:                  ${FWMARK}
Use builtin IPv6-management:    ${DELEGATE}

Persistent Keep Alive:          ${KEEPALIVE}
Route Allowed IPs:              ${ROUTEALLOWEDIPS}
Endpoint host:                  ${ENDPOINT}
Endpoint host port:             ${ENPOINTPORT}
üõ°Ô∏è Torguard wireguard server:   ${ENDPOINT}:${ENPOINTPORT}

Install openwrt dependencies:   ${DEPS}"

read -p "Continue (y/n)?" answer
case "$answer" in 
  y|Y ) echo "starting $0...";
        opkg update && opkg install ${DEPS};
        tginit "${TGUSER}" "${TGPASS}" "${WGINTERFACE}" "${WGIFNR}" "${NOHOSTROUTE}" "${LISTENPORT}" "${MTU}" "${FWMARK}" "${KEEPALIVE}" "${DELEGATE}" "${ROUTEALLOWEDIPS}" "${FIREWALLZONE}" "${ENDPOINT}:${ENPOINTPORT}";;
  n|N ) echo "user abort, script finished"; exit;;
  * ) echo "invalid"; exit;;
esac

read -p "Do you want to install iperf3 and speedperf scripts (y/n)?" setspeedperf
case "$setspeedperf" in 
  y|Y ) opkg update && opkg install ${DEPSSPEEDPERF};${DBIN} /etc/config/speedperf https://github.com/TorGuard/openwrt-scripts/raw/master/etc/config/speedperf;${DBIN} /usr/bin/speedperf https://github.com/TorGuard/openwrt-scripts/raw/master/usr/bin/speedperf;chmod +x /usr/bin/speedperf;;
  n|N ) echo "user abort, script finished"; exit;;
  * ) echo "invalid"; exit;;
esac